<h1 align = "center"> UFPy </h1> <br>

See the `documentation.md` file for a complete summary of all functions and their docstrings, with some additional information here and there.

# Overview
1. [HAM_box.py](#HAM_box)
2. [HAM_plot.py](#HAM_plot)
3. [measurement_data.py](#measurement_data)
4. [utils.py](#utils)
5. [main.py](#main)
6. [Reproduce_thesis.py](#reproduce_thesis)
7. [Example workflow: single run](#example-workflow-single-run)
8. [Example workflow: variation](#example-workflow-variation)

## HAM_box
The most prominent functions of this project are defined in the `HAM_box.py` file. This file serves to run the modified HAM/SALSA2.0 box model implementation. Functions for running the model "normally" are avaiable, as well as for running variation ensembles. Functions that deal with reading the model's output are also in this file.

## HAM_plot
The functions in `HAM_plot.py`are focused on visualising any of the results generated by the model. 

## Measurement_data
Functions for reading and modifying/plotting the various measurement data files used in this project. Likely not generally reusable for other data files, but inspiration could be taken from them.

## utils
Helper functions, that can be used in a variety of situations. Think of functions to transform between specific and relative humidity, calculate complementary colors for clear plotting, and a handy function that makes the model metadata more easily legible. 

## main
As it stands, this is a showcase of the model's workflow.

## Reproduce_thesis
A single file which reproduces all the data and figures presented in the corresponding master's thesis. Be careful with running it; it takes around 6.5 Gigs and a significant amount of time before it's all said and done.

## Example workflow: single run
(This is essentially a copypaste of `main.py`, but that way, you can keep this safe and just edit `main.py` as you like.)
1. Declare input: simulation name, environmental variables, particle flux and dispersion rate
```python
# Give the simulation a name
experiment_name = "Test_1"

# Declare the environmental variables
temp = 290 # Kelvin
humi = 0.005 # kg water per kg air, specific humidity
pressure = 101000 # Pascal

environmental_variables = [temp, humi, pressure] # Order is important

# Particle influx and dispersion

# As it stands, particle_flux is a list with length 9, and dispersion is just a float < 1
# Let's showcase a lognormal input, which needs to be interpolated to salsa's bins
x = np.linspace(3, 1000, 10000) 
lognormal_flux = utils.lognormal(x, sigma = 1.68, center_x = 90, scale = 17e6) # 1e6 for cm^-3 -> m^-3

# Interpolation
bin_boundaries = hp.define_bin_boundaries()
salsa_bins = np.unique(np.concatenate(list(bin_boundaries.values()), 0)[0:10] * 1e9)

particle_flux = np.interp(salsa_bins, x, lognormal_flux)
dispersion_rate = 0.012
```
2. Write the input to the model input file
```python
# These need to be written to every horizontal grid-cell in the system
# The best way of doing a homogenous system, is just by copying the list n-times, for n grid cells
# Right now, it's setup for 6, so
nested_environmental_variables = [environmental_variables]*6
ham.write_environmental_data(nested_environmental_variables)

ham.write_particle_input_data(particle_flux = particle_flux, dispersion_rate = dispersion_rate)
```
3. Run the model
```python
# recompile can be set to False if you're positive you've not changed the f90 source code of the model
ham.run_model(experiment_name=experiment_name, recompile=False)
```

4. Read the model's output
```python
# The read_model_data() function can discern between grid cell
# Right now, the model outputs data for cells 1 and 5
num, metadata = ham.read_model_data(experiment_name, gridcell = 1)
num5, _ = ham.read_model_data(experiment_name, gridcell = 5)

# Some plotting functions require the rdry file, which contains the immediate bin boundaries.
# I've not implemented a function for it, because it's a one-liner
rdry = pd.read_csv(os.path.join(HAM_DATA_FOLDER, "rdry_orig.dat"), sep=r"\s+")

# rdry has radii which are off by 2 orders of magnitudes, because SALSA works
# with cm, "for some reason". Divide everything by 100 to make it SI compliant.
rdry = rdry/100

# Parse metadata into more legible form
metadata = utils.parse_metadata(metadata)
```
5. Plot the results
```python
# Num files are always in m^-3, but these plot functions scale them down to cm^-3 automatically
fig, axes = hp.plot_size_dist(rdry, num5, rows=[100, 600, 1500], ymin=1, xmin = -20, xmax = 400,
                  exp_name = experiment_name, title = "Size distribution (cell 5)", populations = ["a"],
                  label = "Model")

fig, axes = hp.stacked_timeseries_plot(num5, populations = ["a"], ymin = 1, exp_name = experiment_name,
                                       title = "Size distribution evolution (cell 5)",
                                       highlights = [600, 1500], highlight_colors = ["green", "red"])
```

## Example workflow: variation
The order is still the same as in the single run. This uses the `run_variation` function, which is capable of varying the input all by itself. See the more complete documentation for details.

```python
# Declare environmental variables
temps = np.linspace(273, 298, num = 15)
humis = np.linspace(0, 0.006, num = 15)
pap = 101325

# Create all possible (unique) combinations
environmental_values = [[temp, humi, pap] for temp, humi in product(temps, humis)]

# Define the particle flux, by lognormal distribution
x = np.linspace(10, 1000, 10000)
sigma = 1.68
scale = 17e6

bin_boundaries = hp.define_bin_boundaries()
salsa_bins = np.unique(np.concatenate(list(bin_boundaries.values()), 0)[0:10] * 1e9)

diesel_lognormal = utils.lognormal(x, sigma, center_x = 90, scale = scale)
diesel_flux = np.interp(salsa_bins, x, diesel_lognormal)

secondary_lognormal = utils.lognormal(x, sigma, center_x = 20, scale = scale/2)
additional_flux = np.interp(salsa_bins, x, secondary_lognormal)

particle_flux = diesel_flux + additional_flux
dispersion_rate = 0.012

# Define the experiment name, and give it a handy air pressure name
experiment_name = f"Diesel_Flux_TempHumidityVariation{pap}"

# Run the variation
ham.run_variation(experiment_name, environmental_values, [particle_flux], [dispersion_rate])

# Read the variation with the same reading function, it'll take care of everything
numdict, metadict = ham.read_model_data(experiment_name, gricell = 5)
hp.plot_variation_surface(numdict, metadict, experiment_name, "1a1", 1500)
```